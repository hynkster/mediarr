services:
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    network_mode: "host"
    volumes:
      - ${MEDIARR_ROOT}/config/jellyfin:/config
      - ${MEDIARR_ROOT}/cache:/cache
      - ${NAS_ROOT}/movies:/media/movies
      - ${NAS_ROOT}/shows:/media/shows
      - ${NAS_ROOT}/dokus:/media/dokus
      - ${NAS_ROOT}/FlimmitArchiv:/media/flimmit
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - JELLYFIN_FFmpeg__EnableHardwareEncoding=true
      - JELLYFIN_FFmpeg__EnableVAAPI=true
      - JELLYFIN_FFmpeg__VAAPIDevice=/dev/dri/renderD128
      - JELLYFIN_FFmpeg__EncoderThreadCount=4
      - JELLYFIN_FFmpeg__HardwareDecodingCodecs=["h264"]
    devices:
      - /dev/dri/card1:/dev/dri/card1
      - /dev/dri/renderD128:/dev/dri/renderD128
    privileged: false
    group_add:
      - "989"
      - "985"
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8096/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

  plex:
    image: lscr.io/linuxserver/plex:latest
    container_name: plex
    network_mode: "host"
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - VERSION=docker
      - PLEX_CLAIM=${PLEX_CLAIM}
    devices:
      - /dev/dri:/dev/dri
    privileged: false
    group_add:
      - "989"
      - "985"
    volumes:
      - ${MEDIARR_ROOT}/config/plex:/config
      - ${MEDIARR_ROOT}/data/plex/transcode:/transcode
      - ${NAS_ROOT}/movies:/media/movies
      - ${NAS_ROOT}/shows:/media/shows
      - ${NAS_ROOT}/FlimmitArchiv:/media/flimmit
      - /usr/share/libdrm:/home/runner/actions-runner/_work/plex-conan/plex-conan/.conan/data/libdrm/2.4.120-0/sixones/update-expat/build/73ee780ba6ea3ef381da6e7f229c475bfaf477ca/meson-install/share/libdrm:ro
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 4G
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped

  sonarr:
    image: linuxserver/sonarr:latest
    container_name: sonarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${MEDIARR_ROOT}/config/sonarr:/config
      - ${NAS_ROOT}/shows:/tv/shows
      - ${NAS_ROOT}/dokus:/tv/dokus
      - ${NAS_ROOT}/downloads:/downloads
    ports:
      - "8989:8989"
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8989/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - mediarr_network

  radarr:
    image: linuxserver/radarr:latest
    container_name: radarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${MEDIARR_ROOT}/config/radarr:/config
      - ${NAS_ROOT}/movies:/movies
      - ${NAS_ROOT}/downloads:/downloads
    ports:
      - "7878:7878"
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:7878/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - mediarr_network

  gluetun:
    image: qmcgaw/gluetun:v3
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    environment:
      - VPN_SERVICE_PROVIDER=protonvpn
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      - WIREGUARD_ADDRESSES=${WIREGUARD_ADDRESSES}
      - SERVER_COUNTRIES=Belgium
      - TZ=${TZ}
      - LOG_LEVEL=debug
      - FIREWALL_VPN_INPUT_PORTS=6881,1337,6969,80,451
      - VPN_PORT_FORWARDING=on
      - VPN_PORT_FORWARDING_PROVIDER=protonvpn
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - "8888:8888/tcp"
      - "8388:8388/tcp"
      - "${QB_PORT}:8080"
      - "${QB_INCOMING_PORT}:6881"
      - "${QB_INCOMING_PORT}:6881/udp"
    volumes:
      - ${MEDIARR_ROOT}/config/gluetun:/gluetun
      - ${MEDIARR_ROOT}/data/gluetun:/tmp/gluetun
    restart: unless-stopped
    networks:
      - mediarr_network

  qbittorrent:
    image: linuxserver/qbittorrent:latest
    container_name: qbittorrent
    network_mode: "service:gluetun"
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - WEBUI_PORT=8080
      - DOCKER_MODS=ghcr.io/vuetorrent/vuetorrent-lsio-mod:latest
    volumes:
      - ${MEDIARR_ROOT}/config/qbittorrent:/config
      - ${NAS_ROOT}/downloads:/downloads
      - ${MEDIARR_ROOT}/data/gluetun:/gluetun-data
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped

  prowlarr:
    image: linuxserver/prowlarr:latest
    container_name: prowlarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${MEDIARR_ROOT}/config/prowlarr:/config
    ports:
      - "${PROWLARR_PORT}:9696"
    restart: unless-stopped
    networks:
      - mediarr_network

  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    environment:
      - LOG_LEVEL=info
      - TZ=Europe/Vienna
      - CAPTCHA_SOLVER=none
    ports:
      - "${FLARESOLVERR_PORT}:8191"
    restart: unless-stopped
    networks:
      - mediarr_network

  unpackerr:
    image: ghcr.io/unpackerr/unpackerr:latest
    container_name: unpackerr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - UN_SONARR_0_URL=http://sonarr:8989
      - UN_SONARR_0_API_KEY=${SONARR_API_KEY}
      - UN_RADARR_0_URL=http://radarr:7878
      - UN_RADARR_0_API_KEY=${RADARR_API_KEY}
      - UN_PATHS_0=/downloads
    volumes:
      - ${NAS_ROOT}/downloads:/downloads
    restart: unless-stopped
    depends_on:
      - sonarr
      - radarr
    networks:
      - mediarr_network

  healthchecks:
    image: lscr.io/linuxserver/healthchecks:latest
    container_name: healthchecks
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - SITE_ROOT=${HC_SITE_ROOT}
      - SITE_NAME=${HC_SITE_NAME}
      - DEFAULT_FROM_EMAIL=${HC_DEFAULT_FROM_EMAIL}
      - EMAIL_HOST=${HC_EMAIL_HOST}
      - EMAIL_PORT=${HC_EMAIL_PORT}
      - EMAIL_HOST_USER=${HC_EMAIL_HOST_USER}
      - EMAIL_HOST_PASSWORD=${HC_EMAIL_HOST_PASSWORD}
      - EMAIL_USE_TLS=${HC_EMAIL_USE_TLS}
    volumes:
      - ${MEDIARR_ROOT}/config/healthchecks:/config
    ports:
      - "8000:8000"
    restart: unless-stopped
    networks:
      - mediarr_network

  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: --run-once
    restart: "no"

networks:
  mediarr_network:
    driver: bridge
